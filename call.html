<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <title>Tieline Call Manager</title>
    <style>
        body { 
            background-color: #f3f4f6;
        }
        .machine-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .machine-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .machine-card.selected {
            border: 3px solid #3b82f6;
            background-color: #eff6ff;
        }
        .line-btn {
            transition: all 0.2s ease;
        }
        .line-btn:hover {
            transform: scale(1.05);
        }
        .line-btn.selected {
            border: 2px solid #10b981;
            background-color: #d1fae5;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">üìû Tieline Call Manager</h1>
        
        <!-- Section 1: S√©lection de la machine -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">üéõÔ∏è S√©lectionner le codec source</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Merlin -->
                <div class="machine-card bg-gradient-to-br from-blue-100 to-blue-200 p-6 rounded-lg border-2 border-blue-300" 
                     onclick="selectMachine('merlin')" data-machine="merlin">
                    <div class="text-center">
                        <div class="text-4xl mb-2">üéöÔ∏è</div>
                        <h3 class="text-xl font-bold mb-1">Merlin</h3>
                        <p class="text-sm text-gray-600">6 lignes disponibles</p>
                        <p class="text-xs text-gray-500 mt-2">IP: 82.127.52.49:25011</p>
                    </div>
                </div>
                
                <!-- Bridge-IT Studio A -->
                <div class="machine-card bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-lg border-2 border-purple-300" 
                     onclick="selectMachine('bridgeit-a')" data-machine="bridgeit-a">
                    <div class="text-center">
                        <div class="text-4xl mb-2">üéôÔ∏è</div>
                        <h3 class="text-xl font-bold mb-1">Bridge-IT</h3>
                        <p class="text-sm text-gray-600">Studio A</p>
                        <p class="text-xs text-gray-500 mt-2">St√©r√©o / 2√óMono</p>
                    </div>
                </div>
                
                <!-- Bridge-IT Studio B -->
                <div class="machine-card bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-lg border-2 border-purple-300" 
                     onclick="selectMachine('bridgeit-b')" data-machine="bridgeit-b">
                    <div class="text-center">
                        <div class="text-4xl mb-2">üéôÔ∏è</div>
                        <h3 class="text-xl font-bold mb-1">Bridge-IT</h3>
                        <p class="text-sm text-gray-600">Studio B</p>
                        <p class="text-xs text-gray-500 mt-2">St√©r√©o / 2√óMono</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 rounded">
                <p class="text-sm"><strong>Codec s√©lectionn√©:</strong> <span id="machine-selected" class="text-blue-600 font-semibold">Aucun</span></p>
            </div>
        </div>
        
        <!-- Section 2: S√©lection de la ligne (cach√© par d√©faut) -->
        <div id="line-section" class="bg-white shadow-lg rounded-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">üì° S√©lectionner la ligne</h2>
            
            <!-- Lignes Merlin -->
            <div id="merlin-lines" class="hidden">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    <button onclick="selectLine(1)" class="line-btn bg-blue-100 hover:bg-blue-200 py-4 px-3 rounded-lg border-2 border-blue-300" data-line="1">
                        <div class="font-bold text-lg">Ligne 1</div>
                        <div class="text-xs text-gray-600 mt-1" id="merlin-line-1-status">Disponible</div>
                    </button>
                    <button onclick="selectLine(2)" class="line-btn bg-blue-100 hover:bg-blue-200 py-4 px-3 rounded-lg border-2 border-blue-300" data-line="2">
                        <div class="font-bold text-lg">Ligne 2</div>
                        <div class="text-xs text-gray-600 mt-1" id="merlin-line-2-status">Disponible</div>
                    </button>
                    <button onclick="selectLine(3)" class="line-btn bg-blue-100 hover:bg-blue-200 py-4 px-3 rounded-lg border-2 border-blue-300" data-line="3">
                        <div class="font-bold text-lg">Ligne 3</div>
                        <div class="text-xs text-gray-600 mt-1" id="merlin-line-3-status">Disponible</div>
                    </button>
                    <button onclick="selectLine(4)" class="line-btn bg-blue-100 hover:bg-blue-200 py-4 px-3 rounded-lg border-2 border-blue-300" data-line="4">
                        <div class="font-bold text-lg">Ligne 4</div>
                        <div class="text-xs text-gray-600 mt-1" id="merlin-line-4-status">Disponible</div>
                    </button>
                    <button onclick="selectLine(5)" class="line-btn bg-blue-100 hover:bg-blue-200 py-4 px-3 rounded-lg border-2 border-blue-300" data-line="5">
                        <div class="font-bold text-lg">Ligne 5</div>
                        <div class="text-xs text-gray-600 mt-1" id="merlin-line-5-status">Disponible</div>
                    </button>
                    <button onclick="selectLine(6)" class="line-btn bg-blue-100 hover:bg-blue-200 py-4 px-3 rounded-lg border-2 border-blue-300" data-line="6">
                        <div class="font-bold text-lg">Ligne 6</div>
                        <div class="text-xs text-gray-600 mt-1" id="merlin-line-6-status">Disponible</div>
                    </button>
                </div>
            </div>
            
            <!-- Lignes Bridge-IT -->
            <div id="bridgeit-lines" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="selectLine('stereo')" class="line-btn bg-purple-100 hover:bg-purple-200 py-6 px-4 rounded-lg border-2 border-purple-300" data-line="stereo">
                        <div class="font-bold text-xl">Mode St√©r√©o</div>
                        <div class="text-sm text-gray-600 mt-2">1 ligne st√©r√©o</div>
                    </button>
                    <button onclick="selectLine('dual-mono')" class="line-btn bg-purple-100 hover:bg-purple-200 py-6 px-4 rounded-lg border-2 border-purple-300" data-line="dual-mono">
                        <div class="font-bold text-xl">Mode Dual Mono</div>
                        <div class="text-sm text-gray-600 mt-2">2 lignes mono ind√©pendantes</div>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-green-50 rounded">
                <p class="text-sm"><strong>Ligne s√©lectionn√©e:</strong> <span id="line-selected" class="text-green-600 font-semibold">Aucune</span></p>
            </div>
        </div>
        
        <!-- Section 3: Profil/Programme -->
        <div id="profile-section" class="bg-white shadow-lg rounded-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Profil de connexion (Programme)</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- S√©lection profil pr√©d√©fini -->
                <div>
                    <label class="block text-sm font-semibold mb-2">üìã Profils enregistr√©s</label>
                    <select id="profile-select" class="w-full border-2 border-gray-300 rounded-lg p-3 mb-3" onchange="loadProfile()">
                        <option value="">-- S√©lectionner un profil --</option>
                        <option value="music-high">Music High Quality (256 kbps)</option>
                        <option value="music-standard">Music Standard (128 kbps)</option>
                        <option value="voice-high">Voice High Quality (96 kbps)</option>
                        <option value="voice-standard">Voice Standard (64 kbps)</option>
                        <option value="custom">Personnalis√©</option>
                    </select>
                    <button onclick="manageProfiles()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm">
                        ‚úèÔ∏è G√©rer les profils
                    </button>
                </div>
                
                <!-- Configuration manuelle -->
                <div>
                    <label class="block text-sm font-semibold mb-2">üéõÔ∏è Configuration manuelle</label>
                    
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-600">Codec Audio</label>
                            <select id="codec" class="w-full border border-gray-300 rounded p-2 text-sm">
                                <option value="musicam">Musicam</option>
                                <option value="mpeg2">MPEG Layer 2</option>
                                <option value="aptx">aptX Enhanced</option>
                                <option value="opus">Opus</option>
                                <option value="aac">AAC-LD</option>
                                <option value="g722">G.722</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">Bitrate</label>
                                <select id="bitrate" class="w-full border border-gray-300 rounded p-2 text-sm">
                                    <option value="64">64 kbps</option>
                                    <option value="96">96 kbps</option>
                                    <option value="128" selected>128 kbps</option>
                                    <option value="192">192 kbps</option>
                                    <option value="256">256 kbps</option>
                                    <option value="320">320 kbps</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Mode</label>
                                <select id="audio-mode" class="w-full border border-gray-300 rounded p-2 text-sm">
                                    <option value="stereo">St√©r√©o</option>
                                    <option value="mono">Mono</option>
                                    <option value="joint">Joint St√©r√©o</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="smartstream" class="mr-2" checked>
                                <span class="text-sm">SmartStream (adaptation automatique)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 4: Num√©rotation -->
        <div id="dial-section" class="bg-white shadow-lg rounded-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">üìû Num√©rotation</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Phonebook -->
                <div>
                    <label class="block text-sm font-semibold mb-2">üìñ Carnet d'adresses</label>
                    <select id="phonebook" class="w-full border-2 border-gray-300 rounded-lg p-3 mb-3" onchange="loadContact()">
                        <option value="">-- S√©lectionner un contact --</option>
                        <optgroup label="Studios">
                            <option value="studio-principal">Studio Principal</option>
                            <option value="studio-secondaire">Studio Secondaire</option>
                            <option value="regie-technique">R√©gie Technique</option>
                        </optgroup>
                        <optgroup label="Ext√©rieurs">
                            <option value="reporter-mobile-1">Reporter Mobile 1</option>
                            <option value="reporter-mobile-2">Reporter Mobile 2</option>
                            <option value="via-exterieur">VIA Ext√©rieur</option>
                        </optgroup>
                        <optgroup label="R√©seau">
                            <option value="paris-studio">Paris Studio</option>
                            <option value="lyon-antenne">Lyon Antenne</option>
                        </optgroup>
                    </select>
                    <button onclick="managePhonebook()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm">
                        ‚úèÔ∏è G√©rer le carnet d'adresses
                    </button>
                </div>
                
                <!-- Num√©rotation manuelle -->
                <div>
                    <label class="block text-sm font-semibold mb-2">üî¢ Num√©rotation manuelle</label>
                    
                    <div class="mb-3">
                        <label class="text-xs text-gray-600 mb-1 block">Type de connexion</label>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button onclick="setConnectionType('ip')" id="btn-ip" class="py-2 px-4 rounded-lg border-2 border-blue-500 bg-blue-100 font-semibold">
                                üåê IP
                            </button>
                            <button onclick="setConnectionType('isdn')" id="btn-isdn" class="py-2 px-4 rounded-lg border-2 border-gray-300 bg-white font-semibold">
                                ‚òéÔ∏è RNIS
                            </button>
                        </div>
                    </div>
                    
                    <div id="ip-input" class="block">
                        <label class="text-xs text-gray-600 mb-1 block">Adresse IP et Port</label>
                        <input type="text" id="ip-address" placeholder="192.168.1.100:3000" 
                               class="w-full border-2 border-gray-300 rounded-lg p-3 mb-2">
                        <p class="text-xs text-gray-500">Format: IP:Port (ex: 192.168.1.100:3000)</p>
                    </div>
                    
                    <div id="isdn-input" class="hidden">
                        <label class="text-xs text-gray-600 mb-1 block">Num√©ro RNIS</label>
                        <input type="text" id="isdn-number" placeholder="+33 1 23 45 67 89" 
                               class="w-full border-2 border-gray-300 rounded-lg p-3 mb-2">
                        <p class="text-xs text-gray-500">Format international (ex: +33 1 23 45 67 89)</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 5: Actions et Statut -->
        <div id="action-section" class="bg-white shadow-lg rounded-lg p-6 hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Boutons d'action -->
                <div class="lg:col-span-2">
                    <h2 class="text-xl font-bold mb-4">üé¨ Actions</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button id="call-button" onclick="initiateCall()" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-6 rounded-lg text-xl shadow-lg">
                            üìû Appeler
                        </button>
                        <button id="hangup-button" onclick="hangupCall()" 
                                class="bg-red-500 hover:bg-red-600 text-white font-bold py-6 rounded-lg text-xl shadow-lg" disabled>
                            ‚ùå Raccrocher
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="resetAll()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 rounded-lg">
                            üîÑ R√©initialiser
                        </button>
                        <button onclick="saveCurrentConfig()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg">
                            üíæ Sauvegarder
                        </button>
                        <button onclick="loadSavedConfig()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-lg">
                            üìÇ Charger
                        </button>
                    </div>
                </div>
                
                <!-- Statut de l'appel -->
                <div>
                    <h2 class="text-xl font-bold mb-4">üìä Statut</h2>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-semibold">√âtat:</span>
                                <span id="call-status" class="text-sm px-2 py-1 rounded bg-gray-300">Inactif</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold">Dur√©e:</span>
                                <span id="call-duration" class="text-lg font-mono">00:00</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-semibold">Qualit√©:</span>
                                <span id="call-quality" class="text-sm">-</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between text-xs mb-1">
                                <span>Buffer:</span>
                                <span id="buffer-level">0%</span>
                            </div>
                            <div class="w-full bg-gray-300 rounded-full h-2">
                                <div id="buffer-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Log d'activit√© -->
            <div class="mt-6">
                <h3 class="font-semibold mb-2">üìù Log d'activit√©</h3>
                <div id="activity-log" class="bg-gray-50 p-4 rounded-lg max-h-40 overflow-y-auto text-sm font-mono border border-gray-200">
                    <p class="text-gray-500">En attente de s√©lection...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedMachine = null;
        let selectedLine = null;
        let connectionType = 'ip';
        let callActive = false;
        let callTimer = null;
        let callStartTime = null;
        
        // Configuration des machines
        const machines = {
            'merlin': {
                name: 'Merlin',
                ip: '82.127.52.49',
                port: 25011,
                lines: [1, 2, 3, 4, 5, 6],
                api: 'rest' // ou 'cgi' selon le mod√®le
            },
            'bridgeit-a': {
                name: 'Bridge-IT Studio A',
                ip: '192.168.1.101',
                port: 80,
                lines: ['stereo', 'dual-mono'],
                api: 'cgi'
            },
            'bridgeit-b': {
                name: 'Bridge-IT Studio B',
                ip: '192.168.1.102',
                port: 80,
                lines: ['stereo', 'dual-mono'],
                api: 'cgi'
            }
        };
        
        // Profils pr√©d√©finis
        const profiles = {
            'music-high': { codec: 'musicam', bitrate: '256', mode: 'stereo', smartstream: true },
            'music-standard': { codec: 'mpeg2', bitrate: '128', mode: 'stereo', smartstream: true },
            'voice-high': { codec: 'aptx', bitrate: '96', mode: 'mono', smartstream: true },
            'voice-standard': { codec: 'g722', bitrate: '64', mode: 'mono', smartstream: false }
        };
        
        // Contacts du phonebook
        const phonebook = {
            'studio-principal': { type: 'ip', address: '192.168.1.100:3000', profile: 'music-high' },
            'studio-secondaire': { type: 'ip', address: '192.168.1.101:3000', profile: 'music-standard' },
            'regie-technique': { type: 'ip', address: '192.168.1.102:3000', profile: 'voice-high' },
            'reporter-mobile-1': { type: 'isdn', number: '+33123456789', profile: 'voice-standard' },
            'reporter-mobile-2': { type: 'isdn', number: '+33987654321', profile: 'voice-standard' },
            'via-exterieur': { type: 'ip', address: '82.127.52.50:25013', profile: 'music-high' },
            'paris-studio': { type: 'ip', address: '10.0.1.50:3000', profile: 'music-high' },
            'lyon-antenne': { type: 'ip', address: '10.0.2.50:3000', profile: 'music-standard' }
        };
        
        // S√©lectionner une machine
        function selectMachine(machineId) {
            selectedMachine = machineId;
            selectedLine = null;
            
            // Mise √† jour visuelle
            document.querySelectorAll('[data-machine]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-machine="${machineId}"]`).classList.add('selected');
            
            // Afficher le nom
            document.getElementById('machine-selected').textContent = machines[machineId].name;
            
            // Afficher la section lignes
            document.getElementById('line-section').classList.remove('hidden');
            
            // Afficher les bonnes lignes
            document.getElementById('merlin-lines').classList.add('hidden');
            document.getElementById('bridgeit-lines').classList.add('hidden');
            
            if (machineId === 'merlin') {
                document.getElementById('merlin-lines').classList.remove('hidden');
                // Charger le statut des lignes via API
                // loadLineStatus(machineId);
            } else {
                document.getElementById('bridgeit-lines').classList.remove('hidden');
            }
            
            // R√©initialiser la s√©lection de ligne
            document.querySelectorAll('.line-btn').forEach(el => el.classList.remove('selected'));
            document.getElementById('line-selected').textContent = 'Aucune';
            
            // Cacher les sections suivantes
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('dial-section').classList.add('hidden');
            document.getElementById('action-section').classList.add('hidden');
            
            addLog(`Codec s√©lectionn√©: ${machines[machineId].name}`);
        }
        
        // S√©lectionner une ligne
        function selectLine(line) {
            selectedLine = line;
            
            // Mise √† jour visuelle
            document.querySelectorAll('.line-btn').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-line="${line}"]`).classList.add('selected');
            
            // Afficher le nom
            const lineName = typeof line === 'number' ? `Ligne ${line}` : 
                            line === 'stereo' ? 'Mode St√©r√©o' : 'Mode Dual Mono';
            document.getElementById('line-selected').textContent = lineName;
            
            // Afficher les sections suivantes
            document.getElementById('profile-section').classList.remove('hidden');
            document.getElementById('dial-section').classList.remove('hidden');
            document.getElementById('action-section').classList.remove('hidden');
            
            addLog(`Ligne s√©lectionn√©e: ${lineName}`);
        }
        
        // Charger un profil
        function loadProfile() {
            const profileId = document.getElementById('profile-select').value;
            if (!profileId || profileId === 'custom') return;
            
            const profile = profiles[profileId];
            document.getElementById('codec').value = profile.codec;
            document.getElementById('bitrate').value = profile.bitrate;
            document.getElementById('audio-mode').value = profile.mode;
            document.getElementById('smartstream').checked = profile.smartstream;
            
            addLog(`Profil charg√©: ${document.getElementById('profile-select').selectedOptions[0].text}`);
        }
        
        // Charger un contact
        function loadContact() {
            const contactId = document.getElementById('phonebook').value;
            if (!contactId) return;
            
            const contact = phonebook[contactId];
            setConnectionType(contact.type);
            
            if (contact.type === 'ip') {
                document.getElementById('ip-address').value = contact.address;
            } else {
                document.getElementById('isdn-number').value = contact.number;
            }
            
            // Charger le profil associ√©
            document.getElementById('profile-select').value = contact.profile;
            loadProfile();
            
            addLog(`Contact charg√©: ${document.getElementById('phonebook').selectedOptions[0].text}`);
        }
        
        // Changer le type de connexion
        function setConnectionType(type) {
            connectionType = type;
            
            if (type === 'ip') {
                document.getElementById('btn-ip').classList.add('border-blue-500', 'bg-blue-100');
                document.getElementById('btn-ip').classList.remove('border-gray-300', 'bg-white');
                document.getElementById('btn-isdn').classList.remove('border-blue-500', 'bg-blue-100');
                document.getElementById('btn-isdn').classList.add('border-gray-300', 'bg-white');
                document.getElementById('ip-input').classList.remove('hidden');
                document.getElementById('isdn-input').classList.add('hidden');
            } else {
                document.getElementById('btn-isdn').classList.add('border-blue-500', 'bg-blue-100');
                document.getElementById('btn-isdn').classList.remove('border-gray-300', 'bg-white');
                document.getElementById('btn-ip').classList.remove('border-blue-500', 'bg-blue-100');
                document.getElementById('btn-ip').classList.add('border-gray-300', 'bg-white');
                document.getElementById('isdn-input').classList.remove('hidden');
                document.getElementById('ip-input').classList.add('hidden');
            }
        }
        
        // Initier l'appel
        async function initiateCall() {
            if (!selectedMachine) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un codec');
                return;
            }
            if (!selectedLine) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une ligne');
                return;
            }
            
            const destination = connectionType === 'ip' ? 
                document.getElementById('ip-address').value : 
                document.getElementById('isdn-number').value;
                
            if (!destination) {
                alert('‚ö†Ô∏è Veuillez entrer une destination');
                return;
            }
            
            // Configuration de l'appel
            const config = {
                machine: machines[selectedMachine],
                line: selectedLine,
                destination: destination,
                type: connectionType,
                codec: document.getElementById('codec').value,
                bitrate: document.getElementById('bitrate').value,
                mode: document.getElementById('audio-mode').value,
                smartstream: document.getElementById('smartstream').checked
            };
            
            addLog('üöÄ √âtablissement de l\'appel...');
            addLog(`Codec: ${config.machine.name} - Ligne ${selectedLine}`);
            addLog(`Destination: ${destination}`);
            addLog(`Config: ${config.codec} @ ${config.bitrate}kbps`);
            
            document.getElementById('call-status').textContent = 'Connexion...';
            document.getElementById('call-status').className = 'text-sm px-2 py-1 rounded bg-yellow-300';
            
            // Appel API r√©el vers Tieline
            try {
                const result = await makeCallToTieline(config);
                
                if (result.success) {
                    callActive = true;
                    callStartTime = Date.now();
                    document.getElementById('call-button').disabled = true;
                    document.getElementById('hangup-button').disabled = false;
                    document.getElementById('call-status').textContent = 'En ligne';
                    document.getElementById('call-status').className = 'text-sm px-2 py-1 rounded bg-green-300';
                    document.getElementById('call-quality').textContent = 'Excellente';
                    
                    addLog('‚úÖ Appel √©tabli avec succ√®s');
                    
                    // D√©marrer le timer
                    callTimer = setInterval(updateCallDuration, 1000);
                    
                    // Simuler le buffer (en attendant les vraies donn√©es API)
                    simulateBuffer();
                } else {
                    throw new Error(result.error || '√âchec de l\'appel');
                }
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`);
                document.getElementById('call-status').textContent = '√âchec';
                document.getElementById('call-status').className = 'text-sm px-2 py-1 rounded bg-red-300';
                alert(`Erreur lors de l'appel:\n${error.message}`);
            }
        }
        
        // Appel API vers Tieline (√† adapter selon votre API r√©elle)
        async function makeCallToTieline(config) {
            const machine = config.machine;
            const baseUrl = `http://${machine.ip}:${machine.port}`;
            
            // Pour Merlin (API REST)
            if (machine.api === 'rest') {
                try {
                    const response = await fetch(`${baseUrl}/api/v1/connection/dial`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa('admin:votre_password')
                        },
                        body: JSON.stringify({
                            line: config.line,
                            destination: config.destination,
                            codec: config.codec,
                            bitrate: parseInt(config.bitrate),
                            mode: config.mode,
                            smartstream: config.smartstream
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return { success: true, data };
                    } else {
                        return { success: false, error: `HTTP ${response.status}` };
                    }
                } catch (e) {
                    // Mode simulation si l'API n'est pas accessible
                    console.warn('API non accessible, mode simulation');
                    return new Promise(resolve => {
                        setTimeout(() => resolve({ success: true, simulated: true }), 2000);
                    });
                }
            }
            
            // Pour Bridge-IT (CGI)
            else if (machine.api === 'cgi') {
                // Adapter selon l'API CGI de Bridge-IT
                return new Promise(resolve => {
                    setTimeout(() => resolve({ success: true, simulated: true }), 2000);
                });
            }
        }
        
        // Raccrocher
        async function hangupCall() {
            if (!callActive) return;
            
            addLog('üì¥ Fin de l\'appel...');
            
            // Appel API r√©el vers Tieline pour raccrocher
            try {
                await hangupCallToTieline();
                addLog('‚úÖ Appel termin√©');
            } catch (error) {
                addLog(`‚ö†Ô∏è Erreur lors du raccrochage: ${error.message}`);
            }
            
            callActive = false;
            clearInterval(callTimer);
            
            document.getElementById('call-button').disabled = false;
            document.getElementById('hangup-button').disabled = true;
            document.getElementById('call-status').textContent = 'Termin√©';
            document.getElementById('call-status').className = 'text-sm px-2 py-1 rounded bg-gray-300';
            document.getElementById('call-duration').textContent = '00:00';
            document.getElementById('call-quality').textContent = '-';
            document.getElementById('buffer-level').textContent = '0%';
            document.getElementById('buffer-bar').style.width = '0%';
        }
        
        // Raccrocher via API Tieline
        async function hangupCallToTieline() {
            const machine = machines[selectedMachine];
            const baseUrl = `http://${machine.ip}:${machine.port}`;
            
            if (machine.api === 'rest') {
                try {
                    await fetch(`${baseUrl}/api/v1/connection/hangup`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Basic ' + btoa('admin:votre_password')
                        },
                        body: JSON.stringify({ line: selectedLine })
                    });
                } catch (e) {
                    console.warn('API non accessible, mode simulation');
                }
            }
        }
        
        // Mettre √† jour la dur√©e de l'appel
        function updateCallDuration() {
            if (!callActive) return;
            
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('call-duration').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Simuler le buffer (remplacer par vraies donn√©es API)
        function simulateBuffer() {
            let bufferLevel = 0;
            const bufferInterval = setInterval(() => {
                if (!callActive) {
                    clearInterval(bufferInterval);
                    return;
                }
                bufferLevel = Math.min(100, bufferLevel + Math.random() * 10);
                document.getElementById('buffer-level').textContent = Math.round(bufferLevel) + '%';
                document.getElementById('buffer-bar').style.width = bufferLevel + '%';
            }, 500);
        }
        
        // R√©initialiser tout
        function resetAll() {
            if (callActive) {
                if (!confirm('Un appel est en cours. Voulez-vous vraiment r√©initialiser ?')) {
                    return;
                }
                hangupCall();
            }
            
            selectedMachine = null;
            selectedLine = null;
            
            document.querySelectorAll('[data-machine], .line-btn').forEach(el => el.classList.remove('selected'));
            document.getElementById('machine-selected').textContent = 'Aucun';
            document.getElementById('line-selected').textContent = 'Aucune';
            
            document.getElementById('line-section').classList.add('hidden');
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('dial-section').classList.add('hidden');
            document.getElementById('action-section').classList.add('hidden');
            
            document.getElementById('ip-address').value = '';
            document.getElementById('isdn-number').value = '';
            document.getElementById('phonebook').value = '';
            document.getElementById('profile-select').value = '';
            
            addLog('üîÑ R√©initialisation compl√®te');
        }
        
        // Sauvegarder la configuration
        function saveCurrentConfig() {
            const config = {
                machine: selectedMachine,
                line: selectedLine,
                connectionType: connectionType,
                profile: document.getElementById('profile-select').value,
                codec: document.getElementById('codec').value,
                bitrate: document.getElementById('bitrate').value,
                mode: document.getElementById('audio-mode').value,
                smartstream: document.getElementById('smartstream').checked
            };
            
            localStorage.setItem('tieline-call-config', JSON.stringify(config));
            addLog('üíæ Configuration sauvegard√©e');
            alert('‚úÖ Configuration sauvegard√©e avec succ√®s !');
        }
        
        // Charger la configuration sauvegard√©e
        function loadSavedConfig() {
            const saved = localStorage.getItem('tieline-call-config');
            if (!saved) {
                alert('‚ö†Ô∏è Aucune configuration sauvegard√©e');
                return;
            }
            
            const config = JSON.parse(saved);
            
            if (config.machine) {
                selectMachine(config.machine);
                if (config.line) {
                    setTimeout(() => selectLine(config.line), 100);
                }
            }
            
            document.getElementById('profile-select').value = config.profile || '';
            document.getElementById('codec').value = config.codec || 'musicam';
            document.getElementById('bitrate').value = config.bitrate || '128';
            document.getElementById('audio-mode').value = config.mode || 'stereo';
            document.getElementById('smartstream').checked = config.smartstream !== false;
            
            setConnectionType(config.connectionType || 'ip');
            
            addLog('üìÇ Configuration charg√©e');
            alert('‚úÖ Configuration charg√©e avec succ√®s !');
        }
        
        // G√©rer les profils
        function manageProfiles() {
            alert('Fonctionnalit√© √† venir:\n\n- Cr√©er de nouveaux profils\n- Modifier les profils existants\n- Supprimer des profils\n- Importer/Exporter des profils');
        }
        
        // G√©rer le phonebook
        function managePhonebook() {
            alert('Fonctionnalit√© √† venir:\n\n- Ajouter des contacts\n- Modifier les contacts existants\n- Supprimer des contacts\n- Organiser par cat√©gories\n- Importer/Exporter le carnet d\'adresses');
        }
        
        // Ajouter une entr√©e au log
        function addLog(message) {
            const log = document.getElementById('activity-log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('p');
            entry.textContent = `[${time}] ${message}`;
            entry.className = 'text-gray-700 mb-1';
            
            if (log.firstChild && log.firstChild.classList.contains('text-gray-500')) {
                log.innerHTML = '';
            }
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Charger le statut des lignes depuis l'API Tieline (exemple)
        async function loadLineStatus(machineId) {
            const machine = machines[machineId];
            const baseUrl = `http://${machine.ip}:${machine.port}`;
            
            try {
                const response = await fetch(`${baseUrl}/api/v1/connection/status`, {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin:votre_password')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Mettre √† jour le statut de chaque ligne
                    // data.lines.forEach(line => {
                    //     document.getElementById(`merlin-line-${line.id}-status`).textContent = 
                    //         line.connected ? 'En ligne' : 'Disponible';
                    // });
                }
            } catch (e) {
                console.warn('Impossible de charger le statut des lignes');
            }
        }
    </script>
</body>
</html>
