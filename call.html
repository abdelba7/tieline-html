<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <title>Tieline Call Manager</title>
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .step-card {
            animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        .machine-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .machine-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .machine-card.selected {
            border: 3px solid #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        .line-btn, .option-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .line-btn:hover, .option-btn:hover {
            transform: scale(1.05);
        }
        .line-btn.selected, .option-btn.selected {
            border: 3px solid #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        .hidden {
            display: none;
        }
        .progress-step {
            transition: all 0.3s ease;
        }
        .progress-step.active {
            background-color: #10b981;
            color: white;
        }
        .progress-step.completed {
            background-color: #059669;
            color: white;
        }
        .summary-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-5xl mx-auto">
        
        <!-- Header avec r√©capitulatif -->
        <div class="bg-white shadow-lg rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between flex-wrap">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">üìû Tieline Call Manager</h1>
                    <p class="text-sm text-gray-600">Configuration d'appel √©tape par √©tape</p>
                </div>
                <div>
                    <button onclick="resetAll()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                        üîÑ Recommencer
                    </button>
                </div>
            </div>
            
            <!-- R√©capitulatif des choix -->
            <div id="summary" class="mt-4 pt-4 border-t border-gray-200 hidden">
                <h3 class="text-sm font-bold text-gray-700 mb-2">üìã R√©capitulatif :</h3>
                <div class="flex flex-wrap">
                    <span id="sum-codec" class="summary-badge hidden"></span>
                    <span id="sum-line" class="summary-badge hidden"></span>
                    <span id="sum-type" class="summary-badge hidden"></span>
                    <span id="sum-destination" class="summary-badge hidden"></span>
                    <span id="sum-profile" class="summary-badge hidden"></span>
                </div>
            </div>
            
            <!-- Barre de progression -->
            <div class="mt-4 flex items-center justify-between text-xs">
                <div id="progress-1" class="progress-step bg-gray-300 text-gray-600 px-3 py-1 rounded-full">1. Codec</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                <div id="progress-2" class="progress-step bg-gray-300 text-gray-600 px-3 py-1 rounded-full">2. Ligne</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                <div id="progress-3" class="progress-step bg-gray-300 text-gray-600 px-3 py-1 rounded-full">3. Type</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                <div id="progress-4" class="progress-step bg-gray-300 text-gray-600 px-3 py-1 rounded-full">4. Destination</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                <div id="progress-5" class="progress-step bg-gray-300 text-gray-600 px-3 py-1 rounded-full">5. Profil</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
                <div id="progress-6" class="progress-step bg-gray-300 text-gray-600 px-3 py-1 rounded-full">6. Appel</div>
            </div>
        </div>
        
        <!-- √âTAPE 1: S√©lection du Codec -->
        <div id="step-1" class="step-card bg-white shadow-xl rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-2">üéõÔ∏è √âtape 1 : S√©lectionnez le codec</h2>
            <p class="text-sm text-gray-600 mb-6">Choisissez le codec source depuis lequel vous souhaitez √©mettre</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Merlin -->
                <div class="machine-card bg-gradient-to-br from-blue-100 to-blue-200 p-6 rounded-xl border-2 border-blue-300" 
                     onclick="selectMachine('merlin')" data-machine="merlin">
                    <div class="text-center">
                        <div class="text-5xl mb-3">üéöÔ∏è</div>
                        <h3 class="text-xl font-bold mb-2">Merlin</h3>
                        <p class="text-sm text-gray-700 font-semibold">6 lignes disponibles</p>
                        <p class="text-xs text-gray-600 mt-2">82.127.52.49:25011</p>
                    </div>
                </div>
                
                <!-- Bridge-IT Studio A -->
                <div class="machine-card bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-xl border-2 border-purple-300" 
                     onclick="selectMachine('bridgeit-a')" data-machine="bridgeit-a">
                    <div class="text-center">
                        <div class="text-5xl mb-3">üéôÔ∏è</div>
                        <h3 class="text-xl font-bold mb-2">Bridge-IT</h3>
                        <p class="text-sm text-gray-700 font-semibold">Studio A</p>
                        <p class="text-xs text-gray-600 mt-2">St√©r√©o / 2√óMono</p>
                    </div>
                </div>
                
                <!-- Bridge-IT Studio B -->
                <div class="machine-card bg-gradient-to-br from-orange-100 to-orange-200 p-6 rounded-xl border-2 border-orange-300" 
                     onclick="selectMachine('bridgeit-b')" data-machine="bridgeit-b">
                    <div class="text-center">
                        <div class="text-5xl mb-3">üéôÔ∏è</div>
                        <h3 class="text-xl font-bold mb-2">Bridge-IT</h3>
                        <p class="text-sm text-gray-700 font-semibold">Studio B</p>
                        <p class="text-xs text-gray-600 mt-2">St√©r√©o / 2√óMono</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- √âTAPE 2: S√©lection de la Ligne -->
        <div id="step-2" class="step-card bg-white shadow-xl rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold mb-2">üì° √âtape 2 : S√©lectionnez la ligne</h2>
            <p class="text-sm text-gray-600 mb-6">Choisissez la ligne √† utiliser sur le codec <strong id="step2-codec-name"></strong></p>
            
            <!-- Lignes Merlin -->
            <div id="merlin-lines" class="hidden">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    <button onclick="selectLine(1)" class="line-btn bg-blue-50 hover:bg-blue-100 py-4 px-3 rounded-xl border-2 border-blue-300" data-line="1">
                        <div class="font-bold text-lg">Ligne 1</div>
                        <div class="text-xs text-gray-600 mt-1">Disponible</div>
                    </button>
                    <button onclick="selectLine(2)" class="line-btn bg-blue-50 hover:bg-blue-100 py-4 px-3 rounded-xl border-2 border-blue-300" data-line="2">
                        <div class="font-bold text-lg">Ligne 2</div>
                        <div class="text-xs text-gray-600 mt-1">Disponible</div>
                    </button>
                    <button onclick="selectLine(3)" class="line-btn bg-blue-50 hover:bg-blue-100 py-4 px-3 rounded-xl border-2 border-blue-300" data-line="3">
                        <div class="font-bold text-lg">Ligne 3</div>
                        <div class="text-xs text-gray-600 mt-1">Disponible</div>
                    </button>
                    <button onclick="selectLine(4)" class="line-btn bg-blue-50 hover:bg-blue-100 py-4 px-3 rounded-xl border-2 border-blue-300" data-line="4">
                        <div class="font-bold text-lg">Ligne 4</div>
                        <div class="text-xs text-gray-600 mt-1">Disponible</div>
                    </button>
                    <button onclick="selectLine(5)" class="line-btn bg-blue-50 hover:bg-blue-100 py-4 px-3 rounded-xl border-2 border-blue-300" data-line="5">
                        <div class="font-bold text-lg">Ligne 5</div>
                        <div class="text-xs text-gray-600 mt-1">Disponible</div>
                    </button>
                    <button onclick="selectLine(6)" class="line-btn bg-blue-50 hover:bg-blue-100 py-4 px-3 rounded-xl border-2 border-blue-300" data-line="6">
                        <div class="font-bold text-lg">Ligne 6</div>
                        <div class="text-xs text-gray-600 mt-1">Disponible</div>
                    </button>
                </div>
            </div>
            
            <!-- Lignes Bridge-IT -->
            <div id="bridgeit-lines" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="selectLine('stereo')" class="line-btn bg-purple-50 hover:bg-purple-100 py-8 px-6 rounded-xl border-2 border-purple-300" data-line="stereo">
                        <div class="font-bold text-2xl mb-2">üéµ Mode St√©r√©o</div>
                        <div class="text-sm text-gray-600">1 ligne st√©r√©o (L+R)</div>
                    </button>
                    <button onclick="selectLine('dual-mono')" class="line-btn bg-purple-50 hover:bg-purple-100 py-8 px-6 rounded-xl border-2 border-purple-300" data-line="dual-mono">
                        <div class="font-bold text-2xl mb-2">üéöÔ∏è Mode Dual Mono</div>
                        <div class="text-sm text-gray-600">2 lignes mono ind√©pendantes</div>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- √âTAPE 3: Type de connexion -->
        <div id="step-3" class="step-card bg-white shadow-xl rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold mb-2">üåê √âtape 3 : Type de connexion</h2>
            <p class="text-sm text-gray-600 mb-6">Choisissez le type de connexion √† utiliser</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="selectConnectionType('ip')" class="option-btn bg-gradient-to-br from-blue-50 to-blue-100 py-10 px-6 rounded-xl border-2 border-blue-300" data-type="ip">
                    <div class="text-center">
                        <div class="text-5xl mb-3">üåê</div>
                        <div class="font-bold text-2xl mb-2">IP (Internet)</div>
                        <div class="text-sm text-gray-600">Connexion via r√©seau IP</div>
                    </div>
                </button>
                <button onclick="selectConnectionType('isdn')" class="option-btn bg-gradient-to-br from-green-50 to-green-100 py-10 px-6 rounded-xl border-2 border-green-300" data-type="isdn">
                    <div class="text-center">
                        <div class="text-5xl mb-3">‚òéÔ∏è</div>
                        <div class="font-bold text-2xl mb-2">RNIS (ISDN)</div>
                        <div class="text-sm text-gray-600">Connexion via ligne t√©l√©phonique</div>
                    </div>
                </button>
            </div>
        </div>
        
        <!-- √âTAPE 4: Destination -->
        <div id="step-4" class="step-card bg-white shadow-xl rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold mb-2">üéØ √âtape 4 : Destination</h2>
            <p class="text-sm text-gray-600 mb-6">Entrez la destination ou s√©lectionnez un contact</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Phonebook -->
                <div>
                    <label class="block text-sm font-bold mb-3">üìñ Carnet d'adresses</label>
                    <select id="phonebook" class="w-full border-2 border-gray-300 rounded-lg p-3 mb-3 text-base" onchange="loadContact()">
                        <option value="">-- S√©lectionner un contact --</option>
                        <optgroup label="Studios">
                            <option value="studio-principal">Studio Principal</option>
                            <option value="studio-secondaire">Studio Secondaire</option>
                            <option value="regie-technique">R√©gie Technique</option>
                        </optgroup>
                        <optgroup label="Ext√©rieurs">
                            <option value="reporter-mobile-1">Reporter Mobile 1</option>
                            <option value="reporter-mobile-2">Reporter Mobile 2</option>
                            <option value="via-exterieur">VIA Ext√©rieur</option>
                        </optgroup>
                        <optgroup label="R√©seau">
                            <option value="paris-studio">Paris Studio</option>
                            <option value="lyon-antenne">Lyon Antenne</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Saisie manuelle -->
                <div>
                    <label class="block text-sm font-bold mb-3">‚úçÔ∏è Saisie manuelle</label>
                    <div id="ip-input">
                        <input type="text" id="ip-address" placeholder="192.168.1.100:3000" 
                               class="w-full border-2 border-gray-300 rounded-lg p-3 mb-2 text-base">
                        <p class="text-xs text-gray-500">Format: IP:Port</p>
                    </div>
                    <div id="isdn-input" class="hidden">
                        <input type="text" id="isdn-number" placeholder="+33 1 23 45 67 89" 
                               class="w-full border-2 border-gray-300 rounded-lg p-3 mb-2 text-base">
                        <p class="text-xs text-gray-500">Format international</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="confirmDestination()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg text-lg">
                    ‚úÖ Confirmer la destination
                </button>
            </div>
        </div>
        
        <!-- √âTAPE 5: Profil Audio -->
        <div id="step-5" class="step-card bg-white shadow-xl rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold mb-2">‚öôÔ∏è √âtape 5 : Configuration audio</h2>
            <p class="text-sm text-gray-600 mb-6">Choisissez un profil ou configurez manuellement</p>
            
            <div class="mb-6">
                <label class="block text-sm font-bold mb-3">üìã Profils pr√©d√©finis</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="selectProfile('music-high')" class="option-btn bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-300 text-left" data-profile="music-high">
                        <div class="font-bold text-lg">üéµ Music High Quality</div>
                        <div class="text-sm text-gray-600 mt-1">Musicam - 256 kbps - St√©r√©o</div>
                    </button>
                    <button onclick="selectProfile('music-standard')" class="option-btn bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl border-2 border-purple-300 text-left" data-profile="music-standard">
                        <div class="font-bold text-lg">üé∂ Music Standard</div>
                        <div class="text-sm text-gray-600 mt-1">MPEG2 - 128 kbps - St√©r√©o</div>
                    </button>
                    <button onclick="selectProfile('voice-high')" class="option-btn bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-300 text-left" data-profile="voice-high">
                        <div class="font-bold text-lg">üé§ Voice High Quality</div>
                        <div class="text-sm text-gray-600 mt-1">aptX - 96 kbps - Mono</div>
                    </button>
                    <button onclick="selectProfile('voice-standard')" class="option-btn bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-300 text-left" data-profile="voice-standard">
                        <div class="font-bold text-lg">üìû Voice Standard</div>
                        <div class="text-sm text-gray-600 mt-1">G.722 - 64 kbps - Mono</div>
                    </button>
                </div>
            </div>
            
            <div class="border-t pt-6">
                <label class="block text-sm font-bold mb-3">üéõÔ∏è Configuration manuelle</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">Codec</label>
                        <select id="codec" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="musicam">Musicam</option>
                            <option value="mpeg2">MPEG Layer 2</option>
                            <option value="aptx">aptX</option>
                            <option value="opus">Opus</option>
                            <option value="aac">AAC-LD</option>
                            <option value="g722">G.722</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">Bitrate</label>
                        <select id="bitrate" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="64">64 kbps</option>
                            <option value="96">96 kbps</option>
                            <option value="128" selected>128 kbps</option>
                            <option value="192">192 kbps</option>
                            <option value="256">256 kbps</option>
                            <option value="320">320 kbps</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">Mode</label>
                        <select id="audio-mode" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="stereo">St√©r√©o</option>
                            <option value="mono">Mono</option>
                            <option value="joint">Joint St√©r√©o</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center">
                            <input type="checkbox" id="smartstream" class="mr-2" checked>
                            <span class="text-sm">SmartStream</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <button onclick="confirmProfile()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg text-lg">
                    ‚úÖ Confirmer la configuration
                </button>
            </div>
        </div>
        
        <!-- √âTAPE 6: Appel et Monitoring -->
        <div id="step-6" class="step-card bg-white shadow-xl rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold mb-4">üìû √âtape 6 : Gestion de l'appel</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Boutons d'action -->
                <div class="lg:col-span-2">
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl border-2 border-gray-300 mb-6">
                        <h3 class="font-bold text-lg mb-4">üé¨ Contr√¥le d'appel</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button id="call-button" onclick="initiateCall()" 
                                    class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-8 rounded-xl text-2xl shadow-lg">
                                üìû Appeler
                            </button>
                            <button id="hangup-button" onclick="hangupCall()" 
                                    class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-8 rounded-xl text-2xl shadow-lg opacity-50 cursor-not-allowed" disabled>
                                ‚ùå Raccrocher
                            </button>
                        </div>
                    </div>
                    
                    <!-- Log d'activit√© -->
                    <div class="bg-gray-900 text-green-400 p-4 rounded-xl font-mono text-xs h-48 overflow-y-auto">
                        <div id="activity-log">
                            <p class="text-gray-500">[Syst√®me pr√™t]</p>
                        </div>
                    </div>
                </div>
                
                <!-- Monitoring -->
                <div>
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 text-white p-6 rounded-xl">
                        <h3 class="font-bold text-lg mb-4">üìä Monitoring</h3>
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm">√âtat:</span>
                                <span id="call-status" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-700">Inactif</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm">Dur√©e:</span>
                                <span id="call-duration" class="text-3xl font-mono font-bold">00:00</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm">Qualit√©:</span>
                                <span id="call-quality" class="text-lg font-semibold">-</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="quality-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex items-center justify-between text-xs mb-1">
                                <span>Buffer:</span>
                                <span id="buffer-level">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="buffer-bar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // √âtat de l'application
        let state = {
            currentStep: 1,
            machine: null,
            line: null,
            connectionType: null,
            destination: null,
            profile: null,
            callActive: false,
            callTimer: null,
            callStartTime: null
        };
        
        // Configuration des machines
        const machines = {
            'merlin': { name: 'Merlin', ip: '82.127.52.49', port: 25011 },
            'bridgeit-a': { name: 'Bridge-IT Studio A', ip: '192.168.1.101', port: 80 },
            'bridgeit-b': { name: 'Bridge-IT Studio B', ip: '192.168.1.102', port: 80 }
        };
        
        // Profils audio
        const profiles = {
            'music-high': { codec: 'musicam', bitrate: '256', mode: 'stereo', smartstream: true, label: 'Music High (256k)' },
            'music-standard': { codec: 'mpeg2', bitrate: '128', mode: 'stereo', smartstream: true, label: 'Music Std (128k)' },
            'voice-high': { codec: 'aptx', bitrate: '96', mode: 'mono', smartstream: true, label: 'Voice High (96k)' },
            'voice-standard': { codec: 'g722', bitrate: '64', mode: 'mono', smartstream: false, label: 'Voice Std (64k)' }
        };
        
        // Phonebook
        const phonebook = {
            'studio-principal': { type: 'ip', address: '192.168.1.100:3000', profile: 'music-high' },
            'studio-secondaire': { type: 'ip', address: '192.168.1.101:3000', profile: 'music-standard' },
            'regie-technique': { type: 'ip', address: '192.168.1.102:3000', profile: 'voice-high' },
            'reporter-mobile-1': { type: 'isdn', number: '+33123456789', profile: 'voice-standard' },
            'reporter-mobile-2': { type: 'isdn', number: '+33987654321', profile: 'voice-standard' },
            'via-exterieur': { type: 'ip', address: '82.127.52.50:25013', profile: 'music-high' },
            'paris-studio': { type: 'ip', address: '10.0.1.50:3000', profile: 'music-high' },
            'lyon-antenne': { type: 'ip', address: '10.0.2.50:3000', profile: 'music-standard' }
        };
        
        // S√©lectionner machine
        function selectMachine(machineId) {
            state.machine = machineId;
            
            document.querySelectorAll('[data-machine]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-machine="${machineId}"]`).classList.add('selected');
            
            updateSummary('codec', `üìü ${machines[machineId].name}`);
            
            setTimeout(() => {
                hideStep(1);
                showStep(2);
                document.getElementById('step2-codec-name').textContent = machines[machineId].name;
                
                // Afficher les bonnes lignes
                document.getElementById('merlin-lines').classList.add('hidden');
                document.getElementById('bridgeit-lines').classList.add('hidden');
                
                if (machineId === 'merlin') {
                    document.getElementById('merlin-lines').classList.remove('hidden');
                } else {
                    document.getElementById('bridgeit-lines').classList.remove('hidden');
                }
                
                addLog(`Codec s√©lectionn√©: ${machines[machineId].name}`);
            }, 300);
        }
        
        // S√©lectionner ligne
        function selectLine(line) {
            state.line = line;
            
            document.querySelectorAll('.line-btn').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-line="${line}"]`).classList.add('selected');
            
            const lineName = typeof line === 'number' ? `Ligne ${line}` : 
                            line === 'stereo' ? 'St√©r√©o' : 'Dual Mono';
            updateSummary('line', `üì° ${lineName}`);
            
            setTimeout(() => {
                hideStep(2);
                showStep(3);
                addLog(`Ligne s√©lectionn√©e: ${lineName}`);
            }, 300);
        }
        
        // S√©lectionner type de connexion
        function selectConnectionType(type) {
            state.connectionType = type;
            
            document.querySelectorAll('[data-type]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            updateSummary('type', type === 'ip' ? 'üåê IP' : '‚òéÔ∏è RNIS');
            
            // Adapter l'input dans l'√©tape 4
            if (type === 'ip') {
                document.getElementById('ip-input').classList.remove('hidden');
                document.getElementById('isdn-input').classList.add('hidden');
            } else {
                document.getElementById('ip-input').classList.add('hidden');
                document.getElementById('isdn-input').classList.remove('hidden');
            }
            
            setTimeout(() => {
                hideStep(3);
                showStep(4);
                addLog(`Type de connexion: ${type === 'ip' ? 'IP' : 'RNIS'}`);
            }, 300);
        }
        
        // Charger contact
        function loadContact() {
            const contactId = document.getElementById('phonebook').value;
            if (!contactId) return;
            
            const contact = phonebook[contactId];
            
            if (contact.type === 'ip') {
                document.getElementById('ip-address').value = contact.address;
            } else {
                document.getElementById('isdn-number').value = contact.number;
            }
            
            addLog(`Contact charg√©: ${document.getElementById('phonebook').selectedOptions[0].text}`);
        }
        
        // Confirmer destination
        function confirmDestination() {
            const dest = state.connectionType === 'ip' ? 
                document.getElementById('ip-address').value : 
                document.getElementById('isdn-number').value;
            
            if (!dest) {
                alert('‚ö†Ô∏è Veuillez entrer une destination');
                return;
            }
            
            state.destination = dest;
            updateSummary('destination', `üéØ ${dest}`);
            
            hideStep(4);
            showStep(5);
            addLog(`Destination: ${dest}`);
        }
        
        // S√©lectionner profil
        function selectProfile(profileId) {
            state.profile = profileId;
            
            document.querySelectorAll('[data-profile]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-profile="${profileId}"]`).classList.add('selected');
            
            const profile = profiles[profileId];
            document.getElementById('codec').value = profile.codec;
            document.getElementById('bitrate').value = profile.bitrate;
            document.getElementById('audio-mode').value = profile.mode;
            document.getElementById('smartstream').checked = profile.smartstream;
            
            addLog(`Profil s√©lectionn√©: ${profile.label}`);
        }
        
        // Confirmer profil
        function confirmProfile() {
            if (!state.profile) {
                state.profile = 'custom';
            }
            
            const profileLabel = state.profile !== 'custom' ? 
                profiles[state.profile].label : 
                `${document.getElementById('codec').value} ${document.getElementById('bitrate').value}k`;
            
            updateSummary('profile', `‚öôÔ∏è ${profileLabel}`);
            
            hideStep(5);
            showStep(6);
            addLog(`Configuration audio confirm√©e: ${profileLabel}`);
        }
        
        // Initier l'appel
        async function initiateCall() {
            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            addLog('üöÄ √âTABLISSEMENT DE L\'APPEL');
            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            addLog(`Codec: ${machines[state.machine].name}`);
            addLog(`Ligne: ${state.line}`);
            addLog(`Vers: ${state.destination}`);
            addLog(`Type: ${state.connectionType}`);
            addLog('Connexion en cours...');
            
            document.getElementById('call-status').textContent = 'Connexion...';
            document.getElementById('call-status').className = 'px-3 py-1 rounded-full text-xs font-bold bg-yellow-500';
            
            // Simulation de l'appel (remplacer par vraie API)
            setTimeout(() => {
                state.callActive = true;
                state.callStartTime = Date.now();
                
                document.getElementById('call-button').disabled = true;
                document.getElementById('call-button').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('hangup-button').disabled = false;
                document.getElementById('hangup-button').classList.remove('opacity-50', 'cursor-not-allowed');
                
                document.getElementById('call-status').textContent = 'En ligne ‚úÖ';
                document.getElementById('call-status').className = 'px-3 py-1 rounded-full text-xs font-bold bg-green-500';
                document.getElementById('call-quality').textContent = 'Excellente';
                document.getElementById('quality-bar').style.width = '95%';
                
                addLog('‚úÖ APPEL √âTABLI AVEC SUCC√àS');
                addLog('Codec audio actif');
                addLog('Transmission en cours...');
                
                state.callTimer = setInterval(updateCallDuration, 1000);
                simulateBuffer();
            }, 2000);
        }
        
        // Raccrocher
        function hangupCall() {
            if (!state.callActive) return;
            
            addLog('üì¥ FIN DE L\'APPEL');
            
            state.callActive = false;
            clearInterval(state.callTimer);
            
            document.getElementById('call-button').disabled = false;
            document.getElementById('call-button').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('hangup-button').disabled = true;
            document.getElementById('hangup-button').classList.add('opacity-50', 'cursor-not-allowed');
            
            document.getElementById('call-status').textContent = 'Termin√©';
            document.getElementById('call-status').className = 'px-3 py-1 rounded-full text-xs font-bold bg-gray-700';
            document.getElementById('call-duration').textContent = '00:00';
            document.getElementById('call-quality').textContent = '-';
            document.getElementById('quality-bar').style.width = '0%';
            document.getElementById('buffer-level').textContent = '0%';
            document.getElementById('buffer-bar').style.width = '0%';
            
            addLog('‚úÖ Appel termin√© correctement');
        }
        
        // Mettre √† jour dur√©e
        function updateCallDuration() {
            if (!state.callActive) return;
            
            const elapsed = Math.floor((Date.now() - state.callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('call-duration').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Simuler buffer
        function simulateBuffer() {
            let bufferLevel = 0;
            const bufferInterval = setInterval(() => {
                if (!state.callActive) {
                    clearInterval(bufferInterval);
                    return;
                }
                bufferLevel = Math.min(100, bufferLevel + Math.random() * 10);
                document.getElementById('buffer-level').textContent = Math.round(bufferLevel) + '%';
                document.getElementById('buffer-bar').style.width = bufferLevel + '%';
            }, 500);
        }
        
        // Mettre √† jour le r√©capitulatif
        function updateSummary(key, value) {
            document.getElementById('summary').classList.remove('hidden');
            const el = document.getElementById(`sum-${key}`);
            el.textContent = value;
            el.classList.remove('hidden');
        }
        
        // Afficher √©tape
        function showStep(step) {
            state.currentStep = step;
            document.getElementById(`step-${step}`).classList.remove('hidden');
            document.getElementById(`progress-${step}`).classList.add('active');
            if (step > 1) {
                document.getElementById(`progress-${step - 1}`).classList.remove('active');
                document.getElementById(`progress-${step - 1}`).classList.add('completed');
            }
        }
        
        // Cacher √©tape
        function hideStep(step) {
            const stepEl = document.getElementById(`step-${step}`);
            stepEl.classList.add('fade-out');
            setTimeout(() => {
                stepEl.classList.add('hidden');
                stepEl.classList.remove('fade-out');
            }, 300);
        }
        
        // R√©initialiser
        function resetAll() {
            if (state.callActive) {
                if (!confirm('Un appel est en cours. Voulez-vous vraiment recommencer ?')) {
                    return;
                }
                hangupCall();
            }
            
            // R√©initialiser l'√©tat
            state = {
                currentStep: 1,
                machine: null,
                line: null,
                connectionType: null,
                destination: null,
                profile: null,
                callActive: false,
                callTimer: null,
                callStartTime: null
            };
            
            // R√©initialiser l'UI
            document.querySelectorAll('[data-machine], .line-btn, [data-type], [data-profile]').forEach(el => el.classList.remove('selected'));
            document.getElementById('summary').classList.add('hidden');
            document.querySelectorAll('.summary-badge').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.progress-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
            });
            
            // Cacher toutes les √©tapes sauf la premi√®re
            for (let i = 2; i <= 6; i++) {
                document.getElementById(`step-${i}`).classList.add('hidden');
            }
            document.getElementById(`step-1`).classList.remove('hidden');
            
            document.getElementById('ip-address').value = '';
            document.getElementById('isdn-number').value = '';
            document.getElementById('phonebook').value = '';
            
            document.getElementById('progress-1').classList.add('active');
            
            document.getElementById('activity-log').innerHTML = '<p class="text-gray-500">[Syst√®me r√©initialis√©]</p>';
        }
        
        // Ajouter log
        function addLog(message) {
            const log = document.getElementById('activity-log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('p');
            entry.textContent = `[${time}] ${message}`;
            entry.className = 'mb-1';
            
            if (log.firstChild && log.firstChild.classList.contains('text-gray-500')) {
                log.innerHTML = '';
            }
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>
